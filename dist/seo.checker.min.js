"use strict";var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var fs=require("fs"),htmlparser=require("htmlparser2"),stream=require("stream"),SEOChecker=function(){function t(e){_classCallCheck(this,t),this.input=!(void 0===e||!e.input)&&e.input,this.output=void 0!==e&&e.output?e.output:"console",this.maxStrongTags=void 0!==e&&e.maxStrongTags?e.maxStrongTags:15,this.rules=void 0!==e&&e.rules?e.rules:[],this.inputType=this.detectInputType(),this.outputType=this.detectOutputType(),this.outputFile=void 0,this.writeStream=void 0,this.init()}return _createClass(t,[{key:"init",value:function(){var t=this;if("stream"===this.inputType&&(this.writeStream=this.createTempWriteStream(),this.input.on("data",function(e){t.doCheck(e)}),this.input.on("end",function(){t.writeStream.end(),fs.unlink("temp")})),"file"===this.outputType){var e=this.outputFilePath(this.output);this.clearOldOutputFile(e).then(function(){t.outputFile=fs.createWriteStream(e,{flags:"a"})}).catch(function(t){process.stdout.write(t.message)})}}},{key:"createTempWriteStream",value:function(){return fs.createWriteStream("temp")}},{key:"detectInputType",value:function(){if("string"==typeof this.input&&(this.input.endsWith("html")||this.input.endsWith("htm")))return"htmlfile";if(this.input instanceof stream.Readable)return"stream";throw new Error("Unacceptable input type")}},{key:"detectOutputType",value:function(){if("string"==typeof this.output&&"console"===this.output)return"console";if("string"==typeof this.output)return"file";if(this.output instanceof stream.Writable)return"stream";throw"Unacceptable output type"}},{key:"outputFilePath",value:function(t){return t.startsWith("/")?t:__dirname+"/"+t}},{key:"clearOldOutputFile",value:function(t){return fs.existsSync(t)?new Promise(function(e,i){fs.unlink(t,function(t){t&&i("no such file"),e()})}):new Promise(function(t){t()})}},{key:"writeFile",value:function(t){var e=this;if(void 0===this.outputFile){var i=this.outputFilePath(this.output);this.clearOldOutputFile(i).then(function(){e.outputFile=fs.createWriteStream(i,{flags:"a"}),e.outputFile.write(t+"\r\n")}).catch(function(t){throw t})}else this.outputFile.write(t+"\r\n")}},{key:"printOutput",value:function(t){switch(this.outputType){case"console":process.stdout.write(t+"\r\n");break;case"file":this.writeFile(t);break;case"stream":this.output.write(t+"\r\n")}}},{key:"doCheck",value:function(t){var e="";this.raw=t;for(var i=0,n=this.rules.length;i<n;i++)(e=this.rules[i].bind(this)())&&this.printOutput(e);void 0!==this.outputFile&&this.outputFile.end(),"stream"===this.outputType&&this.output.end()}},{key:"check",value:function(){var t=this;if("htmlfile"===this.inputType){var e=new Promise(function(e,i){fs.readFile(t.input,function(t,n){t&&i(t),e(n)})});return e.then(function(e){t.doCheck(e.toString())}).catch(function(t){throw t}),e}}},{key:"addRules",value:function(t){return Array.isArray(t)?this.rules.concat(t):this.rules.push(t),this.rules.length}},{key:"countTagAndAttr",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=0,r=0,u=new htmlparser.Parser({onopentag:function(t,u){t===e&&(n++,""!==i&&u[i]&&r++)}},{decodeEntities:!0});return u.write(t),u.end(),{tag:n,attr:r}}},{key:"checkTagInHead",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=!1,r=!1,u=new htmlparser.Parser({onopentag:function(t,u){if("head"===t&&(n=!0),!n)return!1;""===i?t===e&&(r=!0):t===e&&u.name===i&&(r=!0)},onclosetag:function(t){"head"===t&&(n=!1)}},{decodeEntities:!0});return u.write(t),u.end(),r}},{key:"writer",get:function(){return void 0===this.writeStream&&(this.writeStream=this.createTempWriteStream()),this.writeStream}}],[{key:"imgShouldContainAltAttr",value:function(){var t=this.countTagAndAttr(this.raw,"img","alt"),e=t.tag-t.attr;return e>0&&"There are "+e+" <img> without alt attritube"}},{key:"linkShouldContainRelAttr",value:function(){var t=this.countTagAndAttr(this.raw,"a","rel"),e=t.tag-t.attr;return e>0&&"There are "+e+" <a> without rel attritube"}},{key:"headShouldContainMetaAndTitle",value:function(){var t=!1,e=["descriptions","keywords"];!1===this.checkTagInHead(this.raw,"title")&&(t="This HTML without <title> tag");for(var i=0,n=e.length;i<n;i++)!1===this.checkTagInHead(this.raw,"meta",e[i])&&(!1!==t&&(t+="\r\n"),t='This HTML without <meta name="'+e[i]+'"> tag');return t}},{key:"bodySholdNotContainTooMoreStrong",value:function(){return this.countTagAndAttr(this.raw,"strong").tag>this.maxStrongTags&&"This HTML have more than "+this.maxStrongTags+" <strong> tag"}},{key:"bodySholdNotContainMoreThanOneH1",value:function(){return this.countTagAndAttr(this.raw,"h1").tag>1&&"This HTML have more than one <h1> tag"}}]),t}();module.exports=SEOChecker;
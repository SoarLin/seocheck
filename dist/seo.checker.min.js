"use strict";var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var fs=require("fs"),htmlparser=require("htmlparser2"),SEOChecker=function(){function t(e){_classCallCheck(this,t),this.input=e.input,this.output=e.output||"console",this.maxStrongTags=e.maxStrongTags||15,this.rules=e.rules||[],this.inputType=this.detectInputType(),this.outputType=this.detectOutputType(),this.outputFile=void 0,this.writeStream=void 0}return _createClass(t,[{key:"createTempWriteStream",value:function(){return fs.createWriteStream("temp")}},{key:"detectInputType",value:function(){var t=this;return"string"==typeof this.input&&(this.input.endsWith("html")||this.input.endsWith("htm"))?"htmlfile":(this.writeStream=this.createTempWriteStream(),this.input.on("data",function(e){t.doCheck(e)}),this.input.on("end",function(){t.writeStream.end(),fs.unlink("temp")}),"stream")}},{key:"detectOutputType",value:function(){var t=this;if("string"==typeof this.output&&"console"===this.output)return"console";if("string"==typeof this.output){var e=this.outputFilePath(this.output);return this.clearOldOutputFile(e).then(function(){t.outputFile=fs.createWriteStream(e,{flags:"a"})}).catch(function(t){process.stdout.write(t.message)}),"file"}return"stream"}},{key:"outputFilePath",value:function(t){return t.startsWith("/")?t:__dirname+"/"+t}},{key:"clearOldOutputFile",value:function(t){return fs.existsSync(t)?new Promise(function(e,i){fs.unlink(t,function(t){t&&i("no such file"),e()})}):new Promise(function(t){t()})}},{key:"writeFile",value:function(t){var e=this;if(void 0===this.outputFile){var i=this.outputFilePath(this.output);this.clearOldOutputFile(i).then(function(){e.outputFile=fs.createWriteStream(i,{flags:"a"}),e.outputFile.write(t+"\r\n")}).catch(function(t){throw t})}else this.outputFile.write(t+"\r\n")}},{key:"printOutput",value:function(t){switch(this.outputType){case"console":process.stdout.write(t+"\r\n");break;case"file":this.writeFile(t);break;case"stream":this.output.write(t+"\r\n")}}},{key:"doCheck",value:function(t){var e="";this.raw=t;for(var i=0,n=this.rules.length;i<n;i++)e=this.rules[i].bind(this)(),this.printOutput(e);void 0!==this.outputFile&&this.outputFile.end(),"stream"===this.outputType&&this.output.end()}},{key:"check",value:function(){var t=this;"htmlfile"===this.inputType&&new Promise(function(e,i){fs.readFile(t.input,function(t,n){t&&i(t),e(n)})}).then(function(e){t.doCheck(e.toString())}).catch(function(t){throw t})}},{key:"writer",get:function(){return void 0===this.writeStream&&(this.writeStream=this.createTempWriteStream()),this.writeStream}}],[{key:"imgShouldContainAltAttr",value:function(){var t=0,e=new htmlparser.Parser({onopentag:function(e,i){"img"===e&&(t++,i.alt&&t--)}},{decodeEntities:!0});return e.write(this.raw),e.end(),"There are "+t+" <img> without alt attritube"}},{key:"linkShouldContainRelAttr",value:function(){var t=0,e=new htmlparser.Parser({onopentag:function(e,i){"a"===e&&(t++,i.rel&&t--)}},{decodeEntities:!0});return e.write(this.raw),e.end(),"There are "+t+" <a> without rel attritube"}},{key:"headShouldContainMetaAndTitle",value:function(){var t=!1,e=!1,i="",n=[{name:"description",exist:!1},{name:"keywords",exist:!1}],r=new htmlparser.Parser({onopentag:function(i,r){if("head"===i&&(t=!0),t){"title"===i&&(e=!0);for(var u=0,a=n.length;u<a;u++)"meta"===i&&r.name===n[u].name&&(n[u].exist=!0)}},onclosetag:function(e){"head"===e&&(t=!1)}},{decodeEntities:!0});r.write(this.raw),r.end(),!1===e&&(i+="This HTML without <title> tag");for(var u=0,a=n.length;u<a;u++)!1===n[u].exist&&(""!==i&&(i+="\r\n"),i+='This HTML without <meta name="'+n[u].name+'"> tag');return i}},{key:"bodySholdNotContainTooMoreStrong",value:function(){var t=0,e="",i=new htmlparser.Parser({onopentagname:function(e){"strong"===e&&t++}},{decodeEntities:!0});return i.write(this.raw),i.end(),t>this.maxStrongTags&&(e+="This HTML have more than "+this.maxStrongTags+" <strong> tag"),e}},{key:"bodySholdNotContainMoreThanOneH1",value:function(){var t=0,e="",i=new htmlparser.Parser({onopentagname:function(e){"h1"===e&&t++}},{decodeEntities:!0});return i.write(this.raw),i.end(),t>1&&(e+="This HTML have more than one <h1> tag"),e}}]),t}();module.exports=SEOChecker;